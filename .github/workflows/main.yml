name: Daily Scraper

on:
  schedule:
    - cron: '0 17 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scrape-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'

      # ติดตั้ง Library ที่จำเป็น (เพราะเราต้องใช้ Panther)
      - name: Install Dependencies
        run: composer install --prefer-dist --no-progress

      - name: Run Scraper
        run: php scraper.php

      # ถ้าสำเร็จ ให้ Commit ไฟล์ rates.json
      - name: Commit Result
        if: success()
        run: |
          git config --global user.name "Bot"
          git config --global user.email "bot@bot.com"
          git add rates.json
          git commit -m "Update rates" || exit 0
          git push

      # *** ทีเด็ด: ถ้าพัง ให้ส่งรูปหน้าจอเว็บมาให้เราดู ***
      - name: Upload Screenshots (If Failed)
        if: always() # ทำงานเสมอไม่ว่าจะ Error หรือไม่
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshots
          path: "*.png"